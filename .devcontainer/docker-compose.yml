services:
  dev-container:
    # Dockerfileがあるディレクトリを指定して、イメージをビルドします
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
      args:
        USER_UID: ${UID:-1000}
        USER_GID: ${GID:-1000}
    # コンテナ名を固定します
    container_name: dev-container
    # 共有メモリサイズを増やします (Chromiumの安定動作のため)
    shm_size: 2gb
    # .envファイルから環境変数を読み込みます
    env_file:
      - ./.env.example
    environment:
      START_VNC_SERVER: "true"
    # ボリュームをマウントします
    volumes:
      # Tailscaleの状態を永続化するための名前付きボリューム
      - vnc-container-state:/var/lib/tailscale
      # Geminiの設定と認証情報を永続化するための名前付きボリューム
      - gemini-data:/home/devuser/.gemini
      # GitHub CLIの認証情報を永続化するための名前付きボリューム
      - gh-config:/home/devuser/.config/gh
      # ホストのカレントディレクトリをコンテナのワークスペースにマウントします
      - ..:/home/devuser/workspace:cached
      # gemini-cliの認証情報を、リポジトリ内の.geminiディレクトリにマウントします
      - vscode-server-data:/home/devuser/.vscode-server
      - vscode-config-data:/home/devuser/.local/share/code-server
      - /root/.gemini/oauth_creds.json:/home/devuser/workspace/.gemini/oauth_creds.json:ro
    # Tailscaleの動作に必要な権限を付与します
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
      - SYS_ADMIN
    # Tailscaleに必要なTUNデバイスをマウントします
    devices:
      - /dev/net/tun
    # コンテナを常に起動させておくための設定
    tty: true
    stdin_open: true
    restart: unless-stopped

volumes:
  # Tailscaleの状態を保存する名前付きボリュームを定義します
  vnc-container-state:
  # Geminiのデータを保存する名前付きボリューム
  gemini-data:
  # GitHub CLIの認証情報を保存する名前付きボリューム
  gh-config:
  vscode-server-data:
  vscode-config-data:
