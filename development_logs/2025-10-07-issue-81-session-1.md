## 2025-10-07 issue#81 session#1: E2Eテストの実装（正常系完了、異常系で問題発生）

### 概要

`spotify-automation` CLIツールのE2Eテスト実装に着手。タスクリストのフェーズ1およびフェーズ2（正常系シナリオ）を完了したが、フェーズ3（異常系シナリオ）の実装中に解決困難な問題に直面したため、開発を一時中断する。

### 実施内容

1.  **テスト基盤の構築 (フェーズ1)**
    -   `tests/e2e` ディレクトリ構造とテストフィクスチャ (`test-audio.mp3`) を作成した。
    -   CLIコマンドを実行するためのヘルパー関数 `runCli` を `cli.spec.ts` に実装した。
    -   最初の異常系テスト「`--showId`がない場合に失敗する」を実装し、パスすることを確認した。

2.  **正常系シナリオのテスト実装 (フェーズ2)**
    -   `--dryRun`フラグを使用し、ローカルファイル (`--audioPath`) を指定した際の正常系テストを実装し、パスした。
    -   `--audioPath`を指定しない場合に `tmp/downloads` から最新ファイルを検索するフォールバックロジックの正常系テストを実装し、パスした。
    -   この過程で、`upload.ts`およびテストコード内のパス解決の誤りを特定・修正した。

3.  **異常系シナリオの試行と直面した問題 (フェーズ3)**
    -   `--dryRun`を使用しないテスト（実際のブラウザ起動を伴うテスト）に着手した。
    -   **環境変数の問題**: ユーザーの`.env`ファイルに`SPOTIFY_EMAIL`と`SPOTIFY_PASSWORD`が設定されていないことが判明。これにより、実際の認証を試みるテストが失敗した。
    -   **タイムアウト問題**: 不正な認証情報でログインが失敗するテストを実装しようとしたが、Playwrightのテストが30秒のタイムアウトに達し、テストがハングアップした。
    -   以下のデバッグと修正を試みたが、タイムアウト問題は解決しなかった。
        -   `LoginPage.ts`のログインロジックを改善し、エラーメッセージを待機するようにした。
        -   テストヘルパー`runCli`にタイムアウト機構を実装した。
        -   `spotifyUploader.ts`でブラウザをヘッドレスモード (`headless: true`) で起動するように変更した。

### 問題点

CLIからPlaywrightを起動するテストの実行時に、原因不明のハングアップが発生する。これは、ローカル環境における`pnpm`, `nx`, `ts-node`, `playwright`の相互作用に起因する根深い問題である可能性が高い。

### 今後の対応

-   解決困難なタイムアウト問題のため、異常系のE2Eテスト実装を一時中断する。
-   コードベースを正常系テストが完了した安定した状態に戻すため、異常系テスト実装中に行ったアプリケーションコードへの変更（`LoginPage.ts`, `spotifyUploader.ts`）およびテストファイル（`cli.spec.ts`）の変更を元に戻した。
-   現状をブランチにプッシュし、ユーザーに対応を仰ぐ。
