# 設計書 (design.md)

## 1. 概要

このドキュメントは、Issue #87で報告されたセキュリティ脆弱性の修正に関する技術的な設計を定義する。

## 2. アーキテクチャ

今回の修正は、主にプロジェクトの依存関係を管理する `package.json` と `pnpm-lock.yaml` に影響を与える。アプリケーションのソースコードやインフラストラクチャのアーキテクチャに変更はない。

## 3. 実装方針

脆弱性の特定から修正、検証までのプロセスを以下のように進める。

1.  **脆弱性の特定**: `pnpm audit` コマンドを実行し、脆弱性の詳細（対象パッケージ、依存関係ツリー、修正可能なバージョン）を正確に把握する。

2.  **依存関係の更新**: 
    - `pnpm up <package-name>@latest` コマンドを使用し、脆弱性が報告されているトップレベルの依存関係を最新の安全なバージョンに更新する。
    - 間接的な依存関係（transitive dependencies）に脆弱性がある場合は、まずそれがどのトップレベル依存関係によって導入されているかを特定し、その親を更新する。

3.  **オーバーライドの利用 (最終手段)**: 
    - 互換性の問題で直接的なアップデートが困難な場合、`package.json` の `pnpm.overrides` フィールドを使用して、脆弱な間接的依存関係のバージョンを強制的に上書きする。これは一時的な措置として扱い、根本的な解決策が見つかり次第、オーバーライドは解除する。

4.  **検証**: `pnpm audit` を再度実行し、脆弱性が解消されたことを確認する。

## 4. テスト戦略

依存関係の更新によるデグレード（機能低下）を防ぐため、以下のテストを実施する。

1.  **静的検証**: `pnpm audit` を実行し、脆弱性がゼロになったことを確認する。
2.  **単体テスト**: `pnpm test` を実行し、既存のテストスイートがすべてパスすることを確認する。
3.  **手動テスト (E2E)**: プロジェクトの主要な機能である `upload` スクリプト (`pnpm --filter @my-apps/spotify-automation upload -- --help`) が正常に動作するかを手動で確認し、CLIの応答や挙動に問題がないことを保証する。
4.  **CIによる検証**: 修正をブランチにプッシュし、GitHub Actions上で実行されるCIパイプラインがすべて成功することを確認する。
