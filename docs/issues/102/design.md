# 設計書

## 1. 概要

本設計書では、`spotify-automation`ツールのCLIユーザビリティを向上させるための技術的な設計について記述します。主な変更点は、実行を簡略化するラッパースクリプトの作成と、設定を外部ファイル化するための設定ファイル機能の導入です。

## 2. アーキテクチャ

変更は主に以下の2つのコンポーネントに集中します。

1.  **`scripts/upload.sh`**: `ts-node` を直接呼び出す代わりに、ユーザーが利用するシェルスクリプト。引数を内部の `ts-node` コマンドに中継します。
2.  **`apps/ui-automations/spotify-automation/src/features/spotifyUploader.ts`**: 既存のアップロードスクリプト。設定ファイルを解析し、コマンドライン引数とマージするロジックを追加します。

## 3. 実装方針

### 3.1. ラッパースクリプト (`scripts/upload.sh`)

-   **言語**: `bash`
-   **配置場所**: `apps/ui-automations/spotify-automation/scripts/upload.sh`
-   **機能**:
    -   スクリプトに渡されたすべての引数を、内部で実行する `ts-node` コマンドにそのまま渡します。
    -   `ts-node` のパスや `tsconfig-paths` の設定など、複雑な実行オプションをスクリプト内にカプセル化します。
    -   実行権限 (`+x`) を付与します。

```bash
#!/bin/bash

# スクリプトのディレクトリに移動して実行
cd "$(dirname "$0")/.."

# ts-nodeコマンドを実行
npx ts-node --require tsconfig-paths/register src/features/spotifyUploader.ts "$@"
```

### 3.2. 設定ファイル対応 (`spotifyUploader.ts`)

-   **ライブラリ**: `yargs` を利用してコマンドライン引数を解析します。`fs` モジュールで設定ファイルを読み込みます。
-   **ロジック**:
    1.  `yargs` を使用して、`--config` 引数を定義します。
    2.  `--config` 引数が指定された場合、指定されたパスのJSONファイルを同期的に読み込み、パースします。
    3.  ファイルが存在しない、またはJSONとして不正な場合はエラーをスローします。
    4.  読み込んだ設定オブジェクト、`yargs` が解析したコマンドライン引数オブジェクトの順で `Object.assign()` またはスプレッド構文 (`{...config, ...argv}`) を使い、設定をマージします。これにより、コマンドライン引数が設定ファイルの値を上書きします。
    5.  マージされた設定オブジェクトを元に、ツールの後続処理を実行します。
    6.  `yargs` の設定で、`showId`, `audioPath`, `title`, `description` などの既存の引数も引き続き解析できるようにします。

### 3.3. `README.md` の更新

-   `apps/ui-automations/spotify-automation/README.md` を更新します。
-   **「基本的な使い方」** セクションを新設または更新し、`upload.sh` スクリプトを使った実行方法を記載します。
-   **「設定ファイル」** セクションを新設し、`config.json` のフォーマット例と、`--config` フラグを使った使用方法を説明します。
-   コマンドライン引数が設定ファイルを上書きする動作についても明記します。

## 4. テスト戦略

-   **単体テスト/結合テスト**:
    -   設定ファイルの読み込みとマージロジックを検証するテストケースを `spotifyUploader.spec.ts` に追加します。
        -   `--config` で指定したファイルが正しく読み込まれること。
        -   コマンドライン引数が設定ファイルの値より優先されること。
        -   存在しない設定ファイルを指定した場合にエラーが発生すること。
-   **E2Eテスト**:
    -   `cli.spec.ts` を修正または新規作成し、`upload.sh` スクリプト経由での実行をテストします。
        -   設定ファイルのみを使用してアップロードが成功するシナリオ。
        -   設定ファイルと、それを上書きするコマンドライン引数を組み合わせてアップロードが成功するシナリオ。