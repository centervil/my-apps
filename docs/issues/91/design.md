---
issue_number: 91
title: geminiスラッシュコマンドのauditコマンドを修正する
---

## 1. 設計

### 1.1. アーキテクチャ

本改修は、Gemini CLIのカスタムコマンド定義ファイルである `.gemini/commands/audit.toml` のみを対象とする。このファイルは、`/audit` コマンドが実行された際の動作を定義しており、複数のステップを連結して実行する機能を持つ。

現在の問題は、この `audit.toml` 内で定義されたシェルコマンドが意図通りに実行されていないことに起因する。設計方針として、`audit.toml` の `steps` 配列を修正し、以下の2ステップ構成で監査プロセスを自動化する。

1.  **スクリプト実行ステップ**: `run_shell_command` ツールを使用し、監査に必要なコンテキスト情報を収集する `scripts/collect-audit-context.ts` を実行する。
2.  **監査プロンプトステップ**: ステップ1の標準出力（`stdout`）を後続のプロンプトに `{{stdout}}` の形で埋め込み、LLMに対してそのコンテキストに基づいたコード監査を指示する。

この設計により、単一のコマンドで「コンテキスト収集」と「LLMによる監査」をシームレスに連携させることが可能となる。

### 1.2. 実装方針

1.  **`audit.toml` の解析**: まず、現在の `.gemini/commands/audit.toml` の内容を精査し、コマンドが実行されない原因を特定する。具体的には、`command` の記述方法や引数の渡し方に誤りがないかを確認する。

2.  **コマンドの修正**: `run_shell_command` を使用して `scripts/collect-audit-context.ts` を実行するよう、`command` を修正する。`pnpm` を介してTypeScriptファイルを実行するため、コマンドは `pnpm tsx scripts/collect-audit-context.ts` となる。

3.  **プロンプトの修正**: 監査指示のプロンプトを、ステップ1の実行結果（収集されたコンテキスト）をインプットとして受け取れるように修正する。プロンプト内にプレースホルダー `{{stdout}}` を含めることで、`run_shell_command` の標準出力を動的に注入する。

    ```toml
    # 修正後のプロンプト例
    prompt = """
    以下のコンテキスト情報に基づいて、プロジェクト全体のコード品質、潜在的なバグ、改善点を監査し、詳細なレポートを作成してください。

    コンテキスト:
    ```
    {{stdout}}
    ```
    """
    ```

### 1.3. テスト戦略

本改修のテストは、Gemini CLI環境で実際に対象コマンドを実行することで行う。

1.  **手動テスト**: Gemini CLIで `/audit` コマンドを実行する。
2.  **実行確認**: `scripts/collect-audit-context.ts` がエラーなく実行されることを確認する。
3.  **出力確認**: LLMからの最終的なレスポンスに、スクリプトの実行結果に基づいた監査レポートが含まれていることを目視で確認する。
