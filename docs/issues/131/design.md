# Design: クッキーの有効期限を考慮した厳密な認証チェックの実装

## 1. アーキテクチャ

既存の `src/auth/authManager.ts` 内の `AuthManager` クラスを拡張し、クッキー検証ロジックを強化します。また、CLIのエントリーポイントに近い `src/features/spotifyUploader.ts` でこの検証機能を呼び出し、Fail Fast（早期失敗）を実現します。

### コンポーネント
- **AuthManager**: `isAuthValid` メソッド内にクッキーごとの有効期限チェックロジックを追加します。
- **SpotifyUploader**: アップロード処理の開始シーケンスを変更し、ブラウザ起動前に `AuthManager` を利用して認証状態を確認します。

## 2. 実装詳細

### 2.1. `src/auth/authManager.ts` の変更

`isAuthValid` メソッド（および内部で呼ばれるバリデーションロジック）を以下のように変更します。

1.  **認証ファイルの読み込み**: 既存通りファイルを読み込み、パースする。
2.  **ファイル年齢のチェック**: 既存通り `maxAgeHours` をチェックする。
3.  **クッキー個別チェック (新規)**:
    - `cookies` 配列をループ処理する。
    - 各クッキーの `expires` プロパティを確認する。
        - Playwrightの `Cookie` 型定義では `expires` は `number` (Unix Timestamp in seconds) である。
    - `expires` が存在し、かつ `expires * 1000 < Date.now()` の場合、有効期限切れとみなす。
    - ※ オプションとして、実行中の処理時間を考慮し、「現在時刻 + マージン（例: 5分）」で判定することも検討するが、まずは現在時刻での判定とする。
4.  **エラー送出**:
    - 期限切れのクッキーが見つかった場合、`AuthError` を投げる。エラーコードは既存の `EXPIRED_AUTH` を使用または新しいコードを定義する。

### 2.2. `src/features/spotifyUploader.ts` の変更

`runSpotifyUpload` 関数を以下のように修正します。

1.  認証ファイルパスを取得。
2.  `AuthManager` インスタンスを作成。
3.  ブラウザ起動 (`firefox.launch`) の **前** に、`await authManager.isAuthValid()` を呼び出す。
4.  チェックに失敗（例外発生）した場合、エラーをキャッチしてログ出力し、処理を中断する（再スローしてCLI側でハンドリングさせる）。

## 3. エラーハンドリング

- **AuthError**: `EXPIRED_AUTH` タイプのエラーが発生した場合、ユーザーに対して `pnpm run login` による再認証を促すメッセージを表示する。

## 4. テスト戦略

### 4.1. 単体テスト (`tests/auth/authManager.spec.ts` - 新規または既存拡張)
- **ケース1: 全てのクッキーが有効期限内**: `isAuthValid` が `true` を返すこと。
- **ケース2: ファイルは新しいが、クッキーが期限切れ**: `isAuthValid` がエラーを投げる（または `false`）こと。
    - `expires` が過去の日時のクッキーを含むモックデータを作成してテストする。
- **ケース3: セッションクッキーのみ**: `expires` がない場合はファイルの日時チェックのみで通過すること。

### 4.2. E2E/統合テスト
- 既存のE2Eテストは、有効な認証情報がある前提で動作するため、変更によるリグレッションがないことを確認する。
- 期限切れの認証ファイルを配置した状態でCLIを実行し、ブラウザが起動せずにエラー終了することを検証する（手動またはインテグレーションテスト）。
